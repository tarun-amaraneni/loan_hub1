{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">

<style>
.card-box {
    background: #ffffff;
    border-radius: 14px;
    padding: 25px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}
.header-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}
.header-bar h2 {
    font-size: 22px;
    font-weight: 600;
    color: #2C3F51;
}
.btn-add {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #fff;
    padding: 10px 18px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}
.table-wrapper {
    overflow-x: auto;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 950px;
}
thead {
    background-color: #354A5E;
    color: #fff;
}

th, td {
    padding: 10px 12px;
    border-bottom: 1px solid #e5e7eb;
    text-align: center;
}
input, select {
    width: 100%;
    padding: 7px 10px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
}
.invalid-row input, .invalid-row select {
    border-color: #ef4444;
    background-color: #fee2e2;
}
.btn-delete {
    background: #dc2626;
    color: #fff;
    border: none;
    border-radius: 7px;
    padding: 6px 12px;
    cursor: pointer;
}
.btn-submit {
    margin-top: 20px;
    background: #15803d;
    color: #fff;
    padding: 10px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    float: right;
}
</style>

<form method="POST">
{% csrf_token %}

<div class="card-box">
    <div class="header-bar">
        <h2>ðŸ’° Loans</h2>
        <button type="button" onclick="addRow()" class="btn-add">âž• Add New</button>
    </div>

    <div class="table-wrapper">
        <table id="loanTable">
            <thead>
                <tr>
                    <th>Gen No</th>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Cash</th>
                    <th>Bank1</th>
                    <th>Bank2</th>
                    <th>Adj</th>
                    <th>Date</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <button type="submit" class="btn-submit">ðŸ’¾ Submit</button>
</div>
</form>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
function today() {
    return new Date().toISOString().split('T')[0];
}

function setupAutocomplete($row) {
    const $gen = $row.find('.genInput');
    const $name = $row.find('.nameInput');

    $gen.autocomplete({
        source: "/api/users-autocomplete/",
        minLength: 1,
        select: function(event, ui) {
            $gen.val(ui.item.code);
            $name.val(ui.item.name);
            return false;
        }
    });

    $name.autocomplete({
        source: "/api/users-autocomplete/",
        minLength: 1,
        select: function(event, ui) {
            $name.val(ui.item.name);
            $gen.val(ui.item.code);
            return false;
        }
    });
}

function recalcAmount($row) {
    const cash  = parseFloat($row.find('.cash').val()) || 0;
    const bank1 = parseFloat($row.find('.bank1').val()) || 0;
    const bank2 = parseFloat($row.find('.bank2').val()) || 0;
    const adj   = parseFloat($row.find('.adj').val()) || 0;
    $row.find('.amount').val(cash + bank1 + bank2 + adj);
}

/* âœ… STRICT VALIDATION */
function validateRow($row) {
    let valid = true;
    $row.removeClass('invalid-row');

    // Required fields
    const gen  = $row.find('.genInput').val().trim();
    const name = $row.find('.nameInput').val().trim();
    const type = $row.find('select').val();
    const date = $row.find('input[type="date"]').val();

    if (!gen || !name || !type || !date) {
        valid = false;
    }

    const amount = parseFloat($row.find('.amount').val()) || 0;
    const cash  = parseFloat($row.find('.cash').val()) || 0;
    const bank1 = parseFloat($row.find('.bank1').val()) || 0;
    const bank2 = parseFloat($row.find('.bank2').val()) || 0;
    const adj   = parseFloat($row.find('.adj').val()) || 0;

    if (amount !== (cash + bank1 + bank2 + adj)) {
        valid = false;
    }

    if (!valid) {
        $row.addClass('invalid-row');
    }

    return valid;
}

function addRow() {
    const last = $('#loanTable tbody tr:last');

    if (last.length && !validateRow(last)) {
        alert("âš  Please fill ALL fields and ensure Amount = Cash + Bank1 + Bank2 + Adj before adding a new row.");
        return;
    }

    const row = $(`
        <tr>
            <td><input name="gen_no[]" class="genInput"></td>
            <td><input name="name[]" class="nameInput"></td>
            <td>
                <select name="type[]">
                    <option value="">-- Select --</option>
                    <option>MTL LOAN</option>
                    <option>FDL LOAN</option>
                    <option>KVP/NSC LOAN</option>
                    <option>FIXED DEPOSITS</option>
                    <option>THRIFT FUNDS</option>
                    <option>WELFARE COLLECTIONS</option>
                </select>
            </td>
            <td><input name="amount[]" class="amount" value="0" readonly></td>
            <td><input name="cash[]" class="cash" value="0"></td>
            <td><input name="bank1[]" class="bank1" value="0"></td>
            <td><input name="bank2[]" class="bank2" value="0"></td>
            <td><input name="adj[]" class="adj" value="0"></td>
            <td><input name="date[]" type="date" value="${today()}"></td>
            <td>
                <button type="button" class="btn-delete"
                    onclick="$(this).closest('tr').remove()">ðŸ—‘</button>
            </td>
        </tr>
    `);

    row.find('.cash,.bank1,.bank2,.adj').on('input', function () {
        recalcAmount(row);
    });

    $('#loanTable tbody').append(row);
    setupAutocomplete(row);
}

$(document).ready(function () {
    addRow();
});
</script>


{% endblock %}
